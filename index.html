<!doctype html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Project R, jeu triple A</title>
    <script src="phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script src=»//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js »></script>
    <script type="text/javascript">
        var config = {
            type: Phaser.AUTO,
            width: 1280,
            height: 720,
            transparent: true,
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            physics: {
                default: 'arcade',
                arcade: {
                    debug: true
                }
            }
        };

        var game = new Phaser.Game(config);

        function preload() {
            this.load.image('sky', 'assets/sky.png');
            this.load.image('ground', 'assets/groundmvp.png');
            this.load.image('groundinvi', 'assets/groundinvi.png');

            this.load.spritesheet('perso', 'assets/perso-run.png', {
                frameWidth: 88,
                frameHeight: 94
            })

            this.load.spritesheet('perso-down', 'assets/perso-down.png', {
                //frameWidth: 118,
                //frameHeight: 94
                frameWidth: 88,
                frameHeight: 94
            })

            this.load.spritesheet('perso-up', 'assets/perso-jump.png', {
                frameWidth: 88,
                frameHeight: 94
            })
        }

        function create() {
            this.gameSpeed = 6;

            this.input.keyboard.on('keydown_ESC', function () {
                //  Every single animation in the Animation Manager will be paused:
                if (this.anims.paused) {
                    this.anims.resumeAll();
                    // this.gameSpeed = 6;
                    console.log(currentGameSpeed);
                    this.gameSpeed = currentGameSpeed;
                    timePause = false;
                }
                else {
                    this.anims.pauseAll();
                    currentGameSpeed = this.gameSpeed;
                    this.gameSpeed = 0;
                    timePause = true;
                }
            }, this);

            const { height, width } = this.game.config;
            this.add.image(640, 360, 'sky');

            this.ground = this.add.tileSprite(0, height, width, 170, 'ground').setOrigin(0, 1);

            // var platforms;
            platforms = this.physics.add.staticGroup();
            platforms.create(400, 680, 'groundinvi').setScale(2).refreshBody();
            platforms.create(400, 245, 'groundinvi').setScale(2).refreshBody();

            // let player
            player = this.physics.add.sprite(100, 400, 'perso');
            player.setCollideWorldBounds(true);
            player.setGravityY(5000);
            this.physics.add.collider(player, platforms);

            // console.log(this.physics.add.collider(player, platforms))

            this.anims.create({
                key: 'running',
                frames: this.anims.generateFrameNumbers('perso', { start: 0, end: 15 }),
                frameRate: 16,
                repeat: -1
            });

            this.anims.create({
                key: 'down',
                frames: this.anims.generateFrameNumbers('perso-down', { start: 0, end: 15 }),
                frameRate: 16,
                repeat: -1
            });

            this.anims.create({
                key: 'jump',
                frames: this.anims.generateFrameNumbers('perso-up', { start: 0, end: 8 }),
                frameRate: 16,
                repeat: -1
            });

            console.log(player.body.deltaAbsY());
            console.log(player.body.y);
            console.log(player);

            var jumpTime = 0;
            var downTime = 0;

            this.input.keyboard.on('keydown_SPACE', () => {
                if (!jumpTime == 0) { return; }
                player.body.height = 92;
                player.body.offset.y = 0;
                player.setVelocityY(-1600);
                player.anims.play('jump', true);
                jumpTime = 1;

                //simumation perte de vie
                Vies = this.data.set('vies', this.data.get('vies') - 1);
                // console.log(this.data.get('vies'));
            })


            this.input.keyboard.on('keyup_SPACE', () => {
                jumpTime = 0;
            })


            this.input.keyboard.on('keydown_DOWN', () => {
                if (!downTime == 0) { return; }
                player.body.height = 58;
                player.body.offset.y = 34;
                downTime = 1;
                player.setVelocityY(+1600);
                setTimeout(reUp, 150);
            })

            this.input.keyboard.on('keyup_DOWN', () => {
                downTime = 0;
            })

            if (this.physics.add.collider(player, platforms).active == true) {
                player.anims.play('running', true);
            }

            timeText = this.add.text(1100, 20, '', { font: '30px Roboto', fill: '#00ff00' });
            textVies = this.add.text(1100, 50, '', { font: '30px Roboto', fill: '#00ff00' });
            textVitesse = this.add.text(1100, 80, '', { font: '30px Roboto', fill: '#00ff00' });
            Vies = this.data.set('vies', 3);


            timedEvent = this.time.addEvent({ delay: 1000, callback: onEvent, callbackScope: this, loop: true });
        }

        function reUp() {
            player.body.height = 92;
            player.body.offset.y = 0;
        }

        var timeText;
        var textVies;
        var textVitesse;

        var currentGameSpeed;
        var timePause = false;

        function update() {
            this.ground.tilePositionX += this.gameSpeed;
            timeText.setText('Temps : ' + minute + " : " + seconde);
            textVies.setText('Vies : ' + this.data.get('vies'));
            textVitesse.setText('Vitesse : ' + this.gameSpeed);

            if (player.body.deltaAbsY() > 0) {
                player.anims.play('jump', true);
            } else {
                player.body.height <= 58 ?
                    player.anims.play('down', true) :
                    player.anims.play('running', true);
            }
        }

        var seconde = 0;
        var minute = 0;

        function loopSeconde() {
            if (seconde == 10 || seconde == 20 || seconde == 30 || seconde == 40 || seconde == 50 || seconde == 59) {
                return true;
            } else {
                return false;
            }
        }

        function onEvent() {
            !timePause ? seconde++ : 0;

            if (loopSeconde() == true) { this.gameSpeed++ };

            if (seconde > 59) {
                minute++;
                seconde = 0;

            }
        }
    </script>
</body>

</html>